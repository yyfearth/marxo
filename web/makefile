#
# Makefile for build marxo web console
#
# Runtime: Node.js 0.8+
# Compilers: coffee, lessc, jade
# Minifier: uglifyjs
#

dist = dist

CRST = \033[0m
CYEL = \033[33m
CBLU = \033[34m
CWHT = \033[37m

MODULES = $(shell find js/*.coffee | grep -v -e /utils\. -e /main\. -e /base\. -e /models\. -e /manager\. -e /config\. -e /console\. -e /home\. -e /report\. -e /notification\. -e /diagram\. -e /actions\. -e /profile\.)
DIST_MODULES = $(addprefix $(dist)/, $(MODULES:.coffee=.js))

print = @echo "$(CWHT)- $(CYEL)$< $(CWHT)> $(CBLU)$@$(CRST)"

default: clean js css html res

upload:
	scp -r $(dist)/* wilson@masonwan.com:web/marxo

coffeelint:
	coffeelint -f coffeelint.json js/*.coffee

.PHONY: js css html

clean: clean_js clean_css clean_res clean_html

clean_js:
	rm -rf "$(dist)/js"
clean_lib:
	rm -rf "$(dist)/js/lib"
clean_css:
	rm -rf "$(dist)/css"
clean_res:
	rm -rf "$(dist)/font"
	rm -f "$(dist)/favicon.ico" "$(dist)/robots.txt"
clean_html:
	rm -f $(dist)/*.html

lib: $(dist)/js/lib/require.js $(dist)/js/lib/jquery-ui.js $(dist)/js/lib/d3v3.js $(dist)/js/lib/nvd3.js
modules: $(DIST_MODULES)
js: lib modules
css: $(dist)/css/console.css
html: $(dist)/index.html
res: $(dist)/font $(dist)/favicon.ico $(dist)/robots.txt

$(dist)/favicon.ico: favicon.ico
	$(print)
	cp $^ $@

$(dist)/robots.txt: robots.txt
	$(print)
	cp $^ $@

$(dist)/font: font
	$(print)
	cp -r $^/ $@/

js/lib/common.min.js: js/lib/common.js
	$(print)
	uglifyjs $^ -mco $@ --screw-ie8

js/lib/backgrid.min.js: js/lib/backgrid.js
	$(print)
	uglifyjs $^ -mco $@ --screw-ie8

$(dist)/js/lib/require.js: js/lib/require.js js/lib/common.min.js js/lib/backgrid.min.js js/lib/backbone.localstorage.js js/lib/html5-dataset.js $(dist)/js/main.js
	$(print)
	@mkdir -p $(@D)
	cat $^ | uglifyjs - --screw-ie8 -o $@
	rm -f $(dist)/js/main.js

$(dist)/js/lib/%.js: js/lib/%.js
	$(print)
	@mkdir -p $(@D)
	cp $^ $@

$(dist)/js/main.js: js/utils.coffee js/models.coffee js/base.coffee js/console.coffee js/manager.coffee js/main.coffee js/notification.coffee js/diagram.coffee js/actions.coffee js/home.coffee js/profile.coffee js/config.coffee
	@echo "$(CWHT)- $(CYEL)$^ $(CWHT)> $(CBLU)$@$(CRST)"
	@mkdir -p $(@D)
	coffee -pjc $^ | uglifyjs - -mco $@ --screw-ie8

$(dist)/js/workflow.js: js/workflow.coffee
	$(print)
	@mkdir -p $(@D)
	coffee -pc $< | cat js/lib/jquery-jsplumb.js - | uglifyjs - -mco $@ --screw-ie8

$(dist)/js/event.js: js/event.coffee
	$(print)
	@mkdir -p $(@D)
	coffee -pc $< | cat js/lib/fullcalendar.js - | uglifyjs - -mco $@ --screw-ie8

$(dist)/js/content.js: js/report.coffee js/content.coffee
	@echo "$(CWHT)- $(CYEL)$^ $(CWHT)> $(CBLU)$@$(CRST)"
	@mkdir -p $(@D)
	coffee -pjc $^ | cat js/lib/bootstrap-wysiwyg.js js/lib/bootstrap-fileupload.js - | uglifyjs - -mco $@ --screw-ie8

$(dist)/js/crypto.js: js/crypto.coffee
	$(print)
	@mkdir -p $(@D)
	coffee -pc $< | cat js/lib/crypto-js.js - | uglifyjs - -mco $@ --screw-ie8

$(dist)/js/%.js: js/%.coffee
	$(print)
	@mkdir -p $(@D)
	coffee -pc $< | uglifyjs - -mco $@ --screw-ie8

$(dist)/css/%.css: css/%.less
	$(print)
	@mkdir -p $(@D)
	lessc --no-ie-compat --clean-css $^ $@

$(dist)/index.html: index.jade
	$(print)
	@mkdir -p $(@D)
	jade -Dp . < $< | tr '\n' ' ' | sed -e "s/> </></g" > $@

$(dist)/test.html: test.jade
	$(print)
	@mkdir -p $(@D)
	jade -Dp . < $< | tr '\n' ' ' | sed -e "s/> </></g" > $@
